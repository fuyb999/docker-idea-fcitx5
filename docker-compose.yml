version: "3.8"

services:
  setup:
    image: docker-idea:ubuntu-22.04-v4.6.3
    volumes:
      - ${WORKSPACE}/config:/config:rw
      - ${CONFIG_BACKUP_PATH:-/backup}:/backup
#    environment:
#      - USER_ID=$(id -u)
#      - GROUP_ID=$(id -g)
    command: >
      bash -c '
        if [ x${WORKSPACE} == x ]; then
          echo "Set the WORKSPACE environment variable in the .env file";
          exit 1;
        fi;
        if [ x${APPS_INSTALL_PATH} == x ]; then
          echo "Set the APPS_INSTALL_PATH environment variable in the .env file";
          exit 1;
        fi;
        if [ ! -d /config/xdg/config/JetBrains ]; then
          echo "Restore idea config";
          sleep 1;
          if [ -f /backup/config-idea${IDEA_VERSION}-plugins.tar.bz2.0 ]; then
            cat /backup/config-idea${IDEA_VERSION}-plugins.tar.bz2.* > /backup/config-idea${IDEA_VERSION}-plugins.tar.bz2;
            tar --exclude=/config/.bashrc -jxvf /backup/config-idea${IDEA_VERSION}-plugins.tar.bz2 -C /config --strip-components=1;
            rm -rf /backup/config-idea${IDEA_VERSION}-plugins.tar.bz2;
          elif [ -f /backup/config.tar.bz2 ]; then
            tar --exclude=/config/.bashrc -jxvf /backup/config.tar.bz2 -C /config --strip-components=1;
          else
            echo "The config file not found"
          fi;
        fi;
        until curl  -s -I http://idea-docker:5800 | grep -q "HTTP/1.1 200 OK"; do sleep 30; done;
        echo "All done!";
      '
    healthcheck:
      test: [ "CMD-SHELL", "[ -f /config/xdg/state/logrotate/logrotate.status ]" ]
#      test: [ "CMD-SHELL", "[ -d /tmp ]" ]
      interval: 1s
      timeout: 5s
      retries: 120

  idea-docker:
    depends_on:
      setup:
        condition: service_healthy
    image: docker-idea:ubuntu-22.04-v4.6.3
    build: .
    container_name: idea-docker
    ports:
      - "5900:5900"
    environment:
#      - USER_ID=$(id -u)
#      - GROUP_ID=$(id -g)
      - JDK_VERSION=${JDK_VERSION}
      - IDEA_VERSION=${IDEA_VERSION}
      - NODE_VERSION=${NODE_VERSION}
      - CONDA_VERSION=${CONDA_VERSION}
      - ENABLE_JDK=1
      - ENABLE_NODE=1
      - ENABLE_CONDA=1
        #  deploy:
        # resources:
        #reservations:
        # devices:
        #   - driver: "nvidia"
        #     count: "all"
        #     capabilities: [ "gpu" ]
    volumes:
      - ${WORKSPACE}/config:/config:rw
      - ${WORKSPACE}/projects:/root/IdeaProjects:z
      - ${APPS_INSTALL_PATH:-/opt/container-apps}:/opt/apps:z
      - ./packages:/config/packages
